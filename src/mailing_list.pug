doctype html
head
  meta(charset='utf-8')
  meta(name='viewport' content='width=device-width, initial-scale=1.0')
  meta(name='description' content='A layout example that shows off a responsive product landing page.')
  title MailGun Send
  link(rel='stylesheet' type="text/css" href='/pure.css')
  link(rel='stylesheet' type="text/css" href='/modal.css')
  link(rel='stylesheet' type="text/css" href='/styles.css')
  link(rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css")

  // <link rel="stylesheet" href="dropzone/dist/min/dropzone.min.css">
  script(src='/tinymce/tinymce.min.js')


.splash-container
  .splash
    <h1 class="splash-head">Mailgun <br /> <small>Mailing List</small></h1>
    .card
        h4.text-left Mailing Lists
        table
            thead
                tr
                    th.text-left(width="20%") Name
                    th.text-left(width="60%") Email
                    th.text-center(width="20%") Action
            tbody
                each item, index in mailing_list
                    tr
                        td.text-left(width="20%") #{item.name}
                        td.text-left
                            .overflow-email(title=item.email) #{item.email}
                        td.text-center(width="20%")
                            .div()
                                a.button-success.d-inline-block.pure-button(href='/mailgun/list/download?email='+item.email onclick='getDownloadProgress(' + index + ')' id='download-btn-' + index) DOWNLOAD

script(src='/jquery/jquery.min.js' type="application/javascript")
script(src='/app.js' type="application/javascript")
script(type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js")
script.
    var result = true
    var interval = null;
    function getCookie(cookieName) {
        var name = cookieName + "=";
        var cookies = document.cookie
        var cs = cookies.split(';');
        for (var i = 0; i < cs.length; i++) {
            var c = cs[i];
            while(c.charAt(0) == ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }

    function isDownloadInProgress(index) {
        var loadState = getCookie("downloadCookie");
        if (loadState == "done") {
            // Delete the cookie 
           
            document.cookie = "downloadCookie=; Path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC;";
            const btn = document.getElementById('download-btn-' + index)
            btn.innerHTML = 'Download'

            Toastify({
                text: "Mailing List Successfully Downloaded",
                duration: 3000,
                close: true,
                gravity: "top", // `top` or `bottom`
                position: "center", // `left`, `center` or `right`
                stopOnFocus: true, // Prevents dismissing of toast on hover
                style: {
                    background: "white",
                    borderRadius: "5px",
                    color: "#282828"
                },
                onClick: function(){} // Callback after click
                }).showToast();
            
            result = false
            clearInterval(interval)
        }

        result = true
    }
    function showWaitingSpinner(){
        const loader = document.getElementById("loader")
        loader.classList.remove("hidden")
    }

    function getDownloadProgress(index){
        console.log("Check Download Progress")
        const btn = document.getElementById('download-btn-' + index)
        btn.innerHTML = 'Downloading...'

        interval = setInterval(isDownloadInProgress, 1000, index)
        
        //- while (result){
        //-     result = isDownloadInProgress(index);
        //- }
        //- for(let i=0; i < 1000; i++){
        //-     let result =
        //-     console.log(result)
        //-    if(result){
        //-     continue;
        //-    }else{
        //-     break;
        //- }
        //- while(true){
       
        //-    }
        }
    
       

        
    
    
